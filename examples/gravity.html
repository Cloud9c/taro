<!DOCTYPE html>
<html lang='en'>
	<head>
		<meta charset='UTF-8' />
		<meta name='viewport' content='width=device-width,initial-scale=1' />
		<title>Gravity</title>
		<link rel="stylesheet" href="examples.css" />
	</head>
	<body>
		<canvas id='canvas'></canvas>
		<script type='module'>
			import * as TARO from '../build/taro.module.js';
			import { OrbitControls } from './js/OrbitControls.js';
			import { GUI } from './js/dat.gui.module.js';

			// app setup
			let entity, geo, mat, mesh;

			const app = new TARO.App({
				canvas: document.getElementById('canvas'),
				antialias: true
			});
			const scene = new TARO.Scene();
			app.setScene(scene);
			app.physics.gravity.y = 0;

			TARO.registerComponent('orbit', class {
			
				init() {
					// from cannon-es/callbacks.html
					this.force = new TARO.Vector3();
					this.moonForce = this.entity.getComponent('rigidbody').ref.force;
					this.moonPosition = this.entity.position;
				}
				
				fixedUpdate() {
					this.force.copy(this.moonPosition).normalize().multiplyScalar(9e11*6.674e-11/this.moonPosition.lengthSq()).negate();
					this.moonForce.copy(this.force);
				}

			});
			
			// camera
			entity = new TARO.Entity('camera');
			const camera = entity.addComponent('camera').ref;
			camera.position.set(5, 5, 5);
			const controls = new OrbitControls( camera, app.renderer.domElement );
			controls.maxPolarAngle = Math.PI * 0.5;

			// planet
			entity = new TARO.Entity('planet');
			entity.addComponent('rigidbody', {type: 'static'});
			entity.addComponent('shape', {type: 'sphere'});
			entity.addComponent('geometry', {type: 'sphere'});
			entity.addComponent('material', {
        type: 'standard',
        // map: 'https://raw.githubusercontent.com/MattLoftus/threejs-space-simulations/master/images/earth_texture_2.jpg'
      });
      entity.addComponent('light');

			// moon
			entity = new TARO.Entity('moon');
			entity.addComponent('rigidbody', {mass: 1, velocity: new TARO.Vector3(0, 4, 0), linearDamping: 0.0});
			entity.addComponent('shape', {type: 'sphere'});
			entity.addComponent('orbit');
			entity.addComponent('geometry', {type: 'sphere'});
			entity.addComponent('material', {
        type: 'standard',
        // map: 'https://raw.githubusercontent.com/MattLoftus/threejs-space-simulations/master/images/moon_texture.jpg'
      });
			entity.position.set(3, 0, 0);
			entity.scale.set(0.2, 0.2, 0.2);

			const gui = new GUI();
			gui.add({distance: 3}, 'distance', 1.2, 10).listen().onChange( ( distance ) => {

				entity.position.normalize().multiplyScalar(distance);

			} );

			// start the app
			app.start();

		</script>
	</body>
</html>
